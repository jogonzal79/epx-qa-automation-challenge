// test/posting-limits-fresh-user-simple.spec.ts
import { test, expect } from '@playwright/test';
import { UserCreationHelper, type UserData } from '../helpers/UserCreationHelper.js';
import { PostingPage } from '../pages/PostingPage.js';
import { CarlPage } from '../pages/CarlPage.js';

// NO usar storageState - necesitamos empezar sin autenticaci√≥n
test.use({ 
  storageState: undefined
});

test.describe('Posting Limits - Usuario Fresco (Verificaci√≥n Manual)', () => {
  
  test.beforeEach(async ({ page }) => {
    // Solo limpiar cookies
    await page.context().clearCookies();
  });
  
  test('validar flujo completo: creaci√≥n de usuario + l√≠mites de posting', async ({ page }) => {
    test.setTimeout(600_000); // 10 minutos para permitir verificaci√≥n manual
    
    let userData: UserData;
    
    await test.step('üöÄ Crear usuario completamente nuevo', async () => {
      const userHelper = new UserCreationHelper(page);
      
      console.log('\nüéØ INICIANDO CREACI√ìN DE USUARIO FRESCO');
      console.log('üìß Se usar√° verificaci√≥n manual de email');
      console.log('‚ö†Ô∏è Mantente atento para ingresar el c√≥digo de verificaci√≥n\n');
      
      userData = await userHelper.createFreshUser();
      
      console.log(`\n‚úÖ USUARIO CREADO EXITOSAMENTE`);
      console.log(`üìß Email: ${userData.email}`);
      console.log(`üîë Password: ${userData.password}`);
      console.log(`üë§ Nombre: ${userData.firstName} ${userData.lastName}\n`);
    });
    
    await test.step('üîê Validar que el usuario est√° autenticado', async () => {
      // Verificar URL y elementos de navegaci√≥n
      const currentUrl = page.url();
      console.log(`üìç URL actual: ${currentUrl}`);
      
      // Buscar indicadores de autenticaci√≥n
      const authIndicators = [
        page.locator('a[href="/carl"]'),
        page.locator('[data-testid*="user"]'),
        page.locator('nav'),
        page.locator('header')
      ];
      
      let isAuthenticated = false;
      for (const indicator of authIndicators) {
        if (await indicator.isVisible({ timeout: 5000 }).catch(() => false)) {
          isAuthenticated = true;
          break;
        }
      }
      
      expect(isAuthenticated, 'Usuario debe estar autenticado despu√©s del registro').toBeTruthy();
      console.log('‚úÖ Usuario autenticado correctamente');
    });

    await test.step('üìù Probar 1er Get Advice - debe ser GRATIS', async () => {
      console.log('\nüéØ PROBANDO PRIMER GET ADVICE (GRATIS)');
      
      const postingPage = new PostingPage(page);
      
      // Ir al home si no estamos ah√≠
      if (!page.url().includes('/home') && !page.url().endsWith('/')) {
        await page.goto('https://app-stg.epxworldwide.com/');
        await page.waitForTimeout(3000);
      }
      
      const result = await postingPage.clickGetAdvice();
      
      console.log(`üìä Resultado del primer Get Advice: ${result.type}`);
      console.log(`‚úÖ √âxito: ${result.success}`);
      
      if (result.success && result.type === 'free') {
        console.log('üéâ ¬°PRIMER GET ADVICE DISPONIBLE GRATUITAMENTE!');
        
        // Completar el formulario para consumir el l√≠mite gratuito
        console.log('üìù Completando formulario para consumir l√≠mite gratuito...');
        
        await expect(postingPage.accountingFinanceRadio).toBeVisible({ timeout: 10000 });
        await postingPage.accountingFinanceRadio.click();
        
        await expect(postingPage.descriptionEditor).toBeVisible({ timeout: 10000 });
        await postingPage.descriptionEditor.fill(
          `Prueba de l√≠mites de posting con usuario fresco creado el ${new Date().toISOString()}. ` +
          `Este es el primer Get Advice gratuito para validar que el sistema respeta los l√≠mites por usuario.`
        );
        
        await postingPage.submitButton.click();
        
        // Esperar confirmaci√≥n
        const success = await Promise.race([
          postingPage.wayToGoHeading.isVisible({ timeout: 15000 }),
          page.locator('text=success, text=thank, text=submitted').isVisible({ timeout: 15000 })
        ]);
        
        if (success) {
          console.log('‚úÖ Primer Get Advice enviado exitosamente');
        } else {
          console.log('‚ö†Ô∏è No se detect√≥ confirmaci√≥n clara, pero continuando...');
        }
        
      } else {
        console.log(`‚ö†Ô∏è Resultado inesperado: ${JSON.stringify(result)}`);
        console.log('üí≠ Esto podr√≠a indicar que ya hay l√≠mites o restricciones');
      }
    });

    await test.step('üö´ Probar 2do Get Advice - debe requerir PAGO/UPGRADE', async () => {
      console.log('\nüéØ PROBANDO SEGUNDO GET ADVICE (DEBE ESTAR LIMITADO)');
      
      // Volver al home
      await page.goto('https://app-stg.epxworldwide.com/');
      await page.waitForTimeout(3000);
      
      const postingPage = new PostingPage(page);
      const result = await postingPage.clickGetAdvice();
      
      console.log(`üìä Resultado del segundo Get Advice: ${result.type}`);
      console.log(`‚ùå Bloqueado: ${!result.success}`);
      
      // El segundo intento debe estar limitado
      expect(result.success).toBeFalsy();
      expect(['upgrade_required', 'payment_required', 'limit_reached']).toContain(result.type);
      
      console.log('üéâ ¬°L√çMITES DE POSTING FUNCIONANDO CORRECTAMENTE!');
      console.log(`üîí Tipo de restricci√≥n: ${result.type}`);
      
      // Tomar screenshot del estado de l√≠mite
      await page.screenshot({ 
        path: `test-results/posting-limit-state-${userData.email.split('@')[0]}.png`,
        fullPage: true 
      });
    });

    await test.step('ü§ñ Validar que C.A.R.L. sigue funcionando', async () => {
      console.log('\nüéØ VERIFICANDO QUE C.A.R.L. NO EST√Å AFECTADO POR L√çMITES');
      
      const carl = new CarlPage(page);
      await carl.goto();
      
      await carl.askQuestion('Hello C.A.R.L., can you confirm you are working normally despite posting limits?');
      const response = await carl.waitForResponse({ timeoutMs: 60000 });
      
      expect(response.length).toBeGreaterThan(20);
      console.log(`‚úÖ C.A.R.L. respondi√≥ correctamente: "${response.slice(0, 100)}..."`);
      console.log('‚úÖ C.A.R.L. funciona independientemente de los l√≠mites de posting');
    });

    await test.step('üìä Documentar resultados finales', async () => {
      console.log('\nüéØ GENERANDO REPORTE FINAL');
      
      await page.screenshot({ 
        path: `test-results/final-state-${userData.firstName}-${Date.now()}.png`,
        fullPage: true 
      });
      
      // Crear un resumen en archivo de texto
      const reportContent = `
REPORTE DE PRUEBA DE L√çMITES DE POSTING
======================================

Usuario Creado:
- Email: ${userData.email}
- Nombre: ${userData.firstName} ${userData.lastName}
- Empresa: ${userData.company}
- Fecha: ${new Date().toISOString()}

Resultados de Validaci√≥n:
‚úÖ 1er Get Advice: GRATIS (consumido)
‚ùå 2do Get Advice: REQUIERE PAGO/UPGRADE
‚úÖ C.A.R.L.: Funcionando sin limitaciones

Conclusi√≥n:
üéØ El sistema de l√≠mites de posting funciona correctamente
üîí Los l√≠mites se aplican por usuario como se esperaba
ü§ñ C.A.R.L. no se ve afectado por los l√≠mites de posting

Estado Final: L√çMITES VALIDADOS EXITOSAMENTE
`;

      console.log(reportContent);
      
      // Guardar reporte
      const fs = await import('fs/promises');
      await fs.writeFile(
        `test-results/posting-limits-report-${userData.firstName}.txt`, 
        reportContent
      );
      
      console.log('\nüéâ ¬°PRUEBA DE L√çMITES COMPLETADA EXITOSAMENTE!');
    });
  });

  test('validar detecci√≥n de mensajes de error espec√≠ficos', async ({ page }) => {
    test.setTimeout(400_000);
    
    await test.step('Crear usuario y agotar l√≠mites r√°pidamente', async () => {
      const userHelper = new UserCreationHelper(page);
      const userData = await userHelper.createFreshUser();
      
      console.log(`üìß Usuario para prueba de mensajes: ${userData.email}`);
    });
    
    await test.step('Consumir l√≠mite gratuito r√°pidamente', async () => {
      const postingPage = new PostingPage(page);
      
      // Primer Get Advice (gratis)
      await postingPage.goto();
      await postingPage.clickGetAdvice();
      
      if (await postingPage.accountingFinanceRadio.isVisible({ timeout: 10000 })) {
        await postingPage.accountingFinanceRadio.click();
        await postingPage.descriptionEditor.fill('Consumiendo l√≠mite gratuito para testing');
        await postingPage.submitButton.click();
        await page.waitForTimeout(5000);
      }
    });
    
    await test.step('Analizar mensajes y UI de l√≠mites', async () => {
      await page.goto('https://app-stg.epxworldwide.com/');
      await page.waitForTimeout(3000);
      
      const postingPage = new PostingPage(page);
      await postingPage.clickGetAdvice();
      
      // Analizar elementos de la UI de l√≠mites
      const limitElements = {
        modal: page.locator('[role="dialog"]'),
        upgradeButton: page.locator('button:has-text("Upgrade")'),
        payButton: page.locator('button:has-text("Pay")'),
        priceText: page.locator('text="$29"'),
        limitMessage: page.locator('text=limit, text=reached, text=exceeded'),
        membershipText: page.locator('text=membership, text=member')
      };
      
      console.log('\nüîç AN√ÅLISIS DE UI DE L√çMITES:');
      
      for (const [name, locator] of Object.entries(limitElements)) {
        const isVisible = await locator.isVisible({ timeout: 5000 }).catch(() => false);
        if (isVisible) {
          const text = await locator.first().innerText().catch(() => '');
          console.log(`‚úÖ ${name}: "${text.slice(0, 80)}..."`);
        } else {
          console.log(`‚ùå ${name}: no visible`);
        }
      }
      
      await page.screenshot({ 
        path: 'test-results/limit-ui-analysis.png',
        fullPage: true 
      });
      
      console.log('üìä An√°lisis de UI completado');
    });
  });
});